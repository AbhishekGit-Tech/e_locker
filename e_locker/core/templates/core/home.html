{% extends "core/base.html" %}

{% block title %}Your e-Locker Home{% endblock %}

{% block extra_head %}
  <style>
    /* (Optional) Page-specific CSS */
    h1 { color: #2a7ae2; }
  </style>
{% endblock %}

{% block content %}
  <h1>Welcome, {{ username }}!</h1>
  <p>Email: {{ email }}</p>
  <p>
    <a href="{% url 'profile' %}">
      <button type="button">My Profile</button>
    </a>
  </p>

  <h2>Your Encryption Key</h2>
  <p>This key encrypts/decrypts your files for this session only.</p>
  <div>
    <input
      type="password"
      id="encKey"
      value="{{ enc_key }}"
      readonly
      style="width:400px;"
    >
    <button id="toggleBtn">Show</button>
    <button onclick="copyKey()">Copy to Clipboard</button>
  </div>
  <script>
    const key = "{{ enc_key }}";
    const keyField = document.getElementById("encKey");
    const toggle   = document.getElementById("toggleBtn");
    toggle.onclick = () => {
      if (keyField.type === "password") {
        keyField.type = "text";
        toggle.textContent = "Hide";
      } else {
        keyField.type = "password";
        toggle.textContent = "Show";
      }
    };
    function copyKey() {
      navigator.clipboard.writeText(key)
        .then(() => alert("Key copied!"))
        .catch(err => alert("Copy failed: " + err));
      setTimeout(() => navigator.clipboard.writeText(""), 60000);
    }
  </script>

  <h2>Upload &amp; Encrypt a File</h2>
  <form action="{% url 'upload_file' %}" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="file" required>
    <button type="submit">Encrypt &amp; Upload</button>
  </form>

  <h2>Your Files</h2>
  <ul>
    {% for f in request.user.encryptedfile_set.all %}
      <li>
        {{ f.name }} ({{ f.upload_ts }}) —
        <a href="{% url 'open_anyway' f.id %}">Open Anyway</a> |
        <a href="{% url 'decrypt' f.id %}">Decrypt &amp; Open</a> |
        <a href="{% url 'delete_file' f.id %}"
           onclick="return confirm('Delete “{{ f.name }}”?');">
          Delete
        </a>
      </li>
    {% empty %}
      <li>No files uploaded yet.</li>
    {% endfor %}
  </ul>

  {% if messages %}
    {% for m in messages %}
      <p style="color: green;">{{ m }}</p>
    {% endfor %}
  {% endif %}

  <p><a href="{% url 'logout' %}">Logout</a></p>
{% endblock %}

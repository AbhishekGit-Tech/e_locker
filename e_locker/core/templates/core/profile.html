{% extends "core/base.html" %}

{% block title %}My Profile | e-Locker{% endblock %}

{% block extra_head %}
  <style>
    /* Tab bar styling */
    .tab-bar {
      margin-bottom: 20px;
    }
    .tab-bar button {
      padding: 8px 16px;
      margin-right: 5px;
      border: 1px solid #ccc;
      background: #f7f7f7;
      cursor: pointer;
    }
    .tab-bar button.active {
      background: #e2e2e2;
      font-weight: bold;
    }

    /* Tab-content styling */
    .tab-content {
      display: none;
      padding: 10px;
      border: 1px solid #ccc;
      border-top: none;
      background: #fafafa;
    }
    .tab-content.active {
      display: block;
    }

    /* Accordion panels inside Account Settings */
    .accordion {
      width: 100%;
      border-top: 1px solid #ccc;
    }
    .accordion-section {
      border-bottom: 1px solid #ccc;
    }
    .accordion-header {
      background: #e7e7e7;
      padding: 10px;
      cursor: pointer;
      user-select: none;
      font-weight: bold;
    }
    .accordion-header:hover {
      background: #dfdfdf;
    }
    .accordion-content {
      display: none;
      padding: 10px;
      background: #fff;
    }
    .accordion-content.active {
      display: block;
    }

    /* Profile picture styling */
    #profilePic {
      max-width: 150px;
      max-height: 150px;
      border: 1px solid #999;
      margin-top: 10px;
      position: relative;
    }
    /* “×” remove-picture button */
    #removePicBtn {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #f00;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 14px;
      line-height: 20px;
      cursor: pointer;
    }
  </style>
{% endblock %}

{% block content %}
  <h1>My Profile</h1>

  {% if messages %}
    {% for m in messages %}
      <p style="color: green;">{{ m }}</p>
    {% endfor %}
  {% endif %}

  <div class="tab-bar">
    <button id="tabProfile" class="active" onclick="showTab('profileTab')">Profile</button>
    <button id="tabAccount" onclick="showTab('accountTab')">Account Settings</button>
  </div>

  <div id="profileTab" class="tab-content active">
    <p><strong>Username:</strong> {{ username }}</p>
    <p><strong>Email:</strong> {{ email }}</p>
    <p><strong>Last Login:</strong> {{ request.user.last_login }}</p>
    <p><strong>Profile Last Updated:</strong> {{ request.user.userprofile.last_updated }}</p>
    <p><strong>Date of Birth:</strong> {{ date_of_birth|default:"Not set" }}</p>
    <p><strong>Bio:</strong> {{ bio|default:"No bio provided" }}</p>

    {% if picture_url %}
      <div style="position: relative; display: inline-block;">
        <img id="profilePic" src="{{ picture_url }}" alt="Profile Picture">
        <form method="post" action="{% url 'remove_picture' %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" id="removePicBtn" title="Remove Picture">&times;</button>
        </form>
      </div>
    {% else %}
      <p><strong>Picture:</strong> Not uploaded</p>
    {% endif %}

    <hr>

    <h3>Update Your Profile</h3>
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="save_profile" value="1">
      <p>
        <label>Date of Birth:
          <input type="date" name="date_of_birth" value="{{ date_of_birth }}">
        </label>
      </p>
      <p>
        <label>Bio:<br>
          <textarea name="bio" rows="3" cols="40">{{ bio }}</textarea>
        </label>
      </p>
      <p>
        <label>Upload New Picture:
          <input type="file" name="picture" accept="image/*">
        </label>
      </p>
      <button type="submit">Save Profile</button>
    </form>
  </div>

  <div id="accountTab" class="tab-content">
    <div class="accordion">
      <div class="accordion-section">
        <div class="accordion-header" onclick="toggleAccordion('usernamePanel')">
          Change Username
        </div>
        <div id="usernamePanel" class="accordion-content">
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="change_username" value="1">
            <p>
              <label>New Username:
                <input type="text" name="new_username" value="{{ username }}" required>
              </label>
            </p>
            <button type="submit">Request OTP &amp; Change Username</button>
          </form>
        </div>
      </div>

      <div class="accordion-section">
        <div class="accordion-header" onclick="toggleAccordion('passwordPanel')">
          Change Password
        </div>
        <div id="passwordPanel" class="accordion-content">
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="change_password" value="1">
            <p>
              <label>New Password:
                <input type="password" name="new_password" required>
              </label>
            </p>
            <p>
              <label>Confirm New Password:
                <input type="password" name="confirm_password" required>
              </label>
            </p>
            <button type="submit">Request OTP &amp; Change Password</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <p><a href="{% url 'home' %}">Back to Home</a></p>

  <script>
    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(div => {
        div.classList.remove('active');
      });
      document.querySelectorAll('.tab-bar button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(tabId).classList.add('active');
      if (tabId === 'profileTab') {
        document.getElementById('tabProfile').classList.add('active');
      } else {
        document.getElementById('tabAccount').classList.add('active');
      }
    }
    function toggleAccordion(panelId) {
      const panel = document.getElementById(panelId);
      const isActive = panel.classList.contains('active');
      document.querySelectorAll('.accordion-content').forEach(div => {
        div.classList.remove('active');
      });
      if (!isActive) {
        panel.classList.add('active');
      }
    }
  </script>
{% endblock %}
